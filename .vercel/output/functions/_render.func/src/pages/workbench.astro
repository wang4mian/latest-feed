---
import Layout from '@/layouts/Layout.astro'
import { supabase } from '@/lib/supabase'

// è·å–URLå‚æ•°ä¸­çš„æ–‡ç« ID
const url = Astro.url
const articleId = url.searchParams.get('article')

// å¦‚æœæœ‰æ–‡ç« IDï¼Œè·å–æ–‡ç« è¯¦æƒ…
let currentArticle = null
if (articleId) {
  const { data } = await supabase
    .from('articles')
    .select('*')
    .eq('id', articleId)
    .single()
  currentArticle = data
}

// è·å–å·²é‡‡ç”¨çš„æ–‡ç« åˆ—è¡¨
const { data: adoptedArticles } = await supabase
  .from('articles')
  .select('*')
  .eq('editor_action', 'adopted')
  .order('created_at', { ascending: false })
  .limit(20)
---

<Layout title="ç¼–è¾‘å° - åˆ¶é€ ä¸šæƒ…æŠ¥ç³»ç»Ÿ">
  <div class="h-screen flex flex-col">
    
    <!-- é¡¶éƒ¨å·¥å…·æ  -->
    <div class="bg-white border-b border-gray-200 px-6 py-4 flex-shrink-0">
      <div class="flex items-center justify-between">
        <div class="flex items-center space-x-4">
          <h1 class="text-xl font-bold text-gray-900">âœï¸ ç¼–è¾‘å°</h1>
          {currentArticle && (
            <span class="text-sm text-gray-500">
              æ­£åœ¨ç¼–è¾‘: {currentArticle.raw_content?.title?.substring(0, 50) || 'æ— æ ‡é¢˜'}...
            </span>
          )}
        </div>
        
        <div class="flex items-center space-x-3">
          {currentArticle && (
            <>
              <button id="save-article" class="px-4 py-2 bg-green-500 text-white text-sm rounded hover:bg-green-600">
                ğŸ’¾ ä¿å­˜
              </button>
              <button id="mark-compiled" class="px-4 py-2 bg-blue-500 text-white text-sm rounded hover:bg-blue-600">
                âœ… æ ‡è®°å·²ç¼–è¯‘
              </button>
            </>
          )}
          <a href="/articles" class="px-4 py-2 bg-gray-500 text-white text-sm rounded hover:bg-gray-600">
            ğŸ“° è¿”å›æ–‡ç« æ± 
          </a>
        </div>
      </div>
    </div>

    <!-- ä¸»è¦å†…å®¹åŒºåŸŸ -->
    <div class="flex-1 flex overflow-hidden">
      
      <!-- å·¦ä¾§æ–‡ç« åˆ—è¡¨ -->
      <div class="w-1/4 bg-gray-50 border-r border-gray-200 overflow-y-auto">
        <div class="p-4">
          <h3 class="font-medium text-gray-900 mb-4">ğŸ“‹ å¾…ç¼–è¾‘æ–‡ç« </h3>
          <div class="space-y-2">
            {adoptedArticles?.map(article => {
              const isActive = articleId === article.id
              
              // è§£æai_analysis JSONå­—ç¬¦ä¸²
              let aiAnalysis = {}
              try {
                aiAnalysis = typeof article.ai_analysis === 'string' ? 
                  JSON.parse(article.ai_analysis) : 
                  article.ai_analysis || {}
              } catch (e) {
                aiAnalysis = article.ai_analysis || {}
              }
              
              const valueScore = aiAnalysis.value_score || 0
              
              return (
                <a 
                  href={`/workbench?article=${article.id}`}
                  class={`block p-3 rounded-lg border transition-colors ${
                    isActive 
                      ? 'bg-blue-100 border-blue-300 text-blue-900' 
                      : 'bg-white border-gray-200 hover:bg-gray-50'
                  }`}
                >
                  <div class="flex items-center justify-between mb-2">
                    <span class="text-xs text-gray-500">
                      {new Date(article.created_at).toLocaleDateString('zh-CN')}
                    </span>
                    {valueScore > 0 && (
                      <span class={`text-xs px-2 py-1 rounded ${
                        valueScore >= 8 ? 'bg-green-100 text-green-800' :
                        valueScore >= 6 ? 'bg-yellow-100 text-yellow-800' :
                        'bg-gray-100 text-gray-700'
                      }`}>
                        {valueScore}/10
                      </span>
                    )}
                  </div>
                  <h4 class="text-sm font-medium text-gray-900 line-clamp-2 mb-1">
                    {article.raw_content?.headline || article.raw_content?.title || 'æ— æ ‡é¢˜'}
                  </h4>
                  <p class="text-xs text-gray-600 line-clamp-2">
                    {aiAnalysis?.initial_translation?.substring(0, 100) || aiAnalysis?.summary?.substring(0, 100) || 'æš‚æ— æ‘˜è¦'}...
                  </p>
                  <div class="mt-2">
                    <span class={`text-xs px-2 py-1 rounded ${
                      article.editor_action === 'compiled' ? 'bg-purple-100 text-purple-800' :
                      'bg-yellow-100 text-yellow-800'
                    }`}>
                      {article.editor_action === 'compiled' ? 'å·²ç¼–è¯‘' : 'å¾…ç¼–è¯‘'}
                    </span>
                  </div>
                </a>
              )
            })}
          </div>
        </div>
      </div>

      <!-- å³ä¾§ç¼–è¾‘å™¨åŒºåŸŸ -->
      <div class="flex-1 flex flex-col">
        {currentArticle ? (
          <>
            <!-- æ–‡ç« ä¿¡æ¯ -->
            <div class="bg-white border-b border-gray-200 p-4 flex-shrink-0">
              <h2 class="text-lg font-semibold text-gray-900 mb-2">
                {currentArticle.raw_content?.headline || currentArticle.raw_content?.title || 'æ— æ ‡é¢˜'}
              </h2>
              <div class="flex items-center space-x-4 text-sm text-gray-600">
                <span>ğŸ“… {new Date(currentArticle.created_at).toLocaleDateString('zh-CN')}</span>
                <span>â­ {(typeof currentArticle.ai_analysis === 'string' ? JSON.parse(currentArticle.ai_analysis) : currentArticle.ai_analysis)?.value_score || 0}/10</span>
                <span class={`px-2 py-1 rounded text-xs ${
                  currentArticle.editor_action === 'compiled' ? 'bg-purple-100 text-purple-800' :
                  'bg-yellow-100 text-yellow-800'
                }`}>
                  {currentArticle.editor_action || 'adopted'}
                </span>
                <a href={currentArticle.source_url} target="_blank" class="text-blue-600 hover:underline">
                  ğŸ”— åŸæ–‡é“¾æ¥
                </a>
              </div>
              {(() => {
                const analysis = typeof currentArticle.ai_analysis === 'string' ? 
                  JSON.parse(currentArticle.ai_analysis) : currentArticle.ai_analysis
                const summary = analysis?.initial_translation || analysis?.summary
                return summary && (
                  <div class="mt-3 p-3 bg-gray-50 rounded-lg">
                    <p class="text-sm text-gray-700">
                      <strong>AIæ‘˜è¦:</strong> {summary}
                    </p>
                  </div>
                )
              })()}
            </div>

            <!-- Doocs MD ç¼–è¾‘å™¨ -->
            <div class="flex-1 bg-white">
              <iframe 
                id="editor-iframe" 
                src="/doocs-editor.html" 
                class="w-full h-full border-0"
                style="min-height: 500px;"
              ></iframe>
            </div>
          </>
        ) : (
          <!-- æœªé€‰æ‹©æ–‡ç« æ—¶çš„æç¤º -->
          <div class="flex-1 flex items-center justify-center bg-gray-50">
            <div class="text-center">
              <span class="text-6xl mb-4 block">ğŸ“</span>
              <h3 class="text-xl font-medium text-gray-900 mb-2">é€‰æ‹©æ–‡ç« å¼€å§‹ç¼–è¾‘</h3>
              <p class="text-gray-600 mb-4">ä»å·¦ä¾§åˆ—è¡¨é€‰æ‹©ä¸€ç¯‡å·²é‡‡ç”¨çš„æ–‡ç« è¿›è¡Œç¼–è¯‘</p>
              <a href="/articles" class="inline-flex items-center px-4 py-2 bg-blue-500 text-white rounded-lg hover:bg-blue-600">
                ğŸ“° å‰å¾€æ–‡ç« æ± 
              </a>
            </div>
          </div>
        )}
      </div>
    </div>

  </div>

  <script define:vars={{ currentArticle }}>
    // ç¼–è¾‘å™¨ç›¸å…³åŠŸèƒ½
    let editorIframe = null
    let isEditorReady = false

    if (currentArticle) {
      // ç­‰å¾…ç¼–è¾‘å™¨åŠ è½½
      document.addEventListener('DOMContentLoaded', () => {
        editorIframe = document.getElementById('editor-iframe')
        
        if (editorIframe) {
          editorIframe.onload = function() {
            setTimeout(() => {
              initializeEditor()
            }, 1000)
          }
        }
      })

      // åˆå§‹åŒ–ç¼–è¾‘å™¨å†…å®¹
      function initializeEditor() {
        if (!editorIframe) return

        // å‡†å¤‡åˆå§‹å†…å®¹
        let initialContent = currentArticle.final_content || ''
        
        // å¦‚æœæ²¡æœ‰æœ€ç»ˆå†…å®¹ï¼Œä½¿ç”¨æ¨¡æ¿
        if (!initialContent) {
          const analysis = typeof currentArticle.ai_analysis === 'string' ? 
            JSON.parse(currentArticle.ai_analysis) : currentArticle.ai_analysis
          const rawContent = currentArticle.raw_content
          
          initialContent = `# ${rawContent?.headline || rawContent?.title || 'æ ‡é¢˜'}

## ğŸ“‹ æ–‡ç« æ¦‚è¦

${analysis?.initial_translation || analysis?.summary || 'æš‚æ— æ‘˜è¦'}

## ğŸ” æ ¸å¿ƒè¦ç‚¹

${analysis?.key_points ? analysis.key_points.map(point => `- ${point}`).join('\n') : 'æš‚æ— è¦ç‚¹'}

## ğŸ’¼ å•†ä¸šå½±å“

${analysis?.business_impact || 'æš‚æ— å•†ä¸šå½±å“åˆ†æ'}

## ğŸ¯ ç›®æ ‡å—ä¼—

${analysis?.target_audience_tags ? analysis.target_audience_tags.join('ã€') : 'æš‚æ— ç›®æ ‡å—ä¼—'}

## ğŸ“ˆ ä»·å€¼è¯„åˆ†

**è¯„åˆ†:** ${analysis?.value_score || 0}/10

**è¯„åˆ†åŸå› :** ${analysis?.score_reason || 'æš‚æ— è¯„åˆ†è¯´æ˜'}

---

*æ–‡ç« æ¥æº: [åŸæ–‡é“¾æ¥](${currentArticle.source_url})*
*AIè¯„åˆ†: ${analysis?.value_score || 0}/10*
*ç¼–è¾‘æ—¶é—´: ${new Date().toLocaleString('zh-CN')}*`
        }

        // å‘é€å†…å®¹åˆ°ç¼–è¾‘å™¨
        editorIframe.contentWindow.postMessage({
          source: 'parent',
          action: 'setContent',
          data: initialContent
        }, '*')

        isEditorReady = true
      }

      // ç›‘å¬ç¼–è¾‘å™¨æ¶ˆæ¯
      window.addEventListener('message', (event) => {
        if (event.data.source === 'doocs-editor') {
          if (event.data.action === 'ready') {
            isEditorReady = true
          } else if (event.data.action === 'contentResponse') {
            // å¤„ç†ç¼–è¾‘å™¨è¿”å›çš„å†…å®¹
            handleEditorContent(event.data.data)
          }
        }
      })

      // ä¿å­˜æ–‡ç« 
      document.getElementById('save-article')?.addEventListener('click', async () => {
        if (!isEditorReady || !editorIframe) return
        
        // è¯·æ±‚ç¼–è¾‘å™¨å†…å®¹
        editorIframe.contentWindow.postMessage({
          source: 'parent',
          action: 'getContent'
        }, '*')
      })

      // æ ‡è®°ä¸ºå·²ç¼–è¯‘
      document.getElementById('mark-compiled')?.addEventListener('click', async () => {
        if (!isEditorReady || !editorIframe) return
        
        // è¯·æ±‚ç¼–è¾‘å™¨å†…å®¹å¹¶æ ‡è®°ä¸ºå·²ç¼–è¯‘
        editorIframe.contentWindow.postMessage({
          source: 'parent',
          action: 'getContent'
        }, '*')
        
        // è®¾ç½®æ ‡å¿—ï¼Œä¸‹æ¬¡æ”¶åˆ°å†…å®¹æ—¶æ ‡è®°ä¸ºå·²ç¼–è¯‘
        document.shouldMarkCompiled = true
      })

      // å¤„ç†ç¼–è¾‘å™¨å†…å®¹
      async function handleEditorContent(content) {
        try {
          const shouldCompile = document.shouldMarkCompiled || false
          document.shouldMarkCompiled = false

          const response = await fetch('/api/articles/update', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
              id: currentArticle.id,
              final_content: content,
              editor_action: shouldCompile ? 'compiled' : currentArticle.editor_action,
              status: shouldCompile ? 'compiled' : currentArticle.status
            })
          })

          if (response.ok) {
            if (shouldCompile) {
              alert('æ–‡ç« å·²æ ‡è®°ä¸ºç¼–è¯‘å®Œæˆï¼')
              // è·³è½¬åˆ°æ–‡ç« æ± æŸ¥çœ‹ç»“æœ
              window.location.href = '/articles'
            } else {
              alert('å†…å®¹å·²ä¿å­˜ï¼')
            }
          } else {
            alert('ä¿å­˜å¤±è´¥')
          }
        } catch (error) {
          console.error('ä¿å­˜å¤±è´¥:', error)
          alert('ä¿å­˜å¤±è´¥')
        }
      }
    }
  </script>

  <style>
    .line-clamp-2 {
      display: -webkit-box;
      -webkit-line-clamp: 2;
      -webkit-box-orient: vertical;
      overflow: hidden;
    }
  </style>
</Layout>