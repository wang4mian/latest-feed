---
import Layout from '@/layouts/Layout.astro'
import { supabase } from '@/lib/supabase'

// è·å–RSSèµ„æºæ•°æ®
const { data: rssResources } = await supabase
  .from('rss_resources')
  .select('*')
  .order('success_rate', { ascending: false })

// ä»URLå‚æ•°è·å–ç­›é€‰æ¡ä»¶
const url = Astro.url
const categoryFilter = url.searchParams.get('category') || 'all'
const statusFilter = url.searchParams.get('status') || 'all'
const regionFilter = url.searchParams.get('region') || 'all'
const strategyFilter = url.searchParams.get('strategy') || 'all'

// è·å–ç­›é€‰é€‰é¡¹
const categories = [...new Set(rssResources?.map(r => r.category).filter(Boolean) || [])]
const regions = [...new Set(rssResources?.map(r => r.region).filter(Boolean) || [])]
const strategies = [...new Set(rssResources?.map(r => r.crawl_strategy).filter(Boolean) || [])]

// åº”ç”¨ç­›é€‰æ¡ä»¶
let filteredResources = rssResources || []
if (categoryFilter !== 'all') {
  filteredResources = filteredResources.filter(r => r.category === categoryFilter)
}
if (statusFilter !== 'all') {
  const isActive = statusFilter === 'active'
  filteredResources = filteredResources.filter(r => r.is_active === isActive)
}
if (regionFilter !== 'all') {
  filteredResources = filteredResources.filter(r => r.region === regionFilter)
}
if (strategyFilter !== 'all') {
  filteredResources = filteredResources.filter(r => r.crawl_strategy === strategyFilter)
}

// ç»Ÿè®¡æ•°æ®
const totalSources = rssResources?.length || 0
const activeSources = rssResources?.filter(r => r.is_active).length || 0
const filteredCount = filteredResources.length
---

<Layout title="RSSæºç®¡ç† - åˆ¶é€ ä¸šæƒ…æŠ¥ç³»ç»Ÿ">
  <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
    
    <!-- é¡µé¢æ ‡é¢˜ -->
    <div class="mb-8">
      <h1 class="text-3xl font-bold text-gray-900">ğŸ“¡ RSSæºç®¡ç†</h1>
      <p class="mt-2 text-gray-600">ç®¡ç†å’Œç›‘æ§åˆ¶é€ ä¸šæƒ…æŠ¥RSSæº</p>
    </div>

    <!-- ç»Ÿè®¡å¡ç‰‡ -->
    <div class="grid grid-cols-1 md:grid-cols-4 gap-6 mb-8">
      <div class="bg-white rounded-lg shadow p-6">
        <div class="flex items-center">
          <div class="p-2 bg-blue-100 rounded-lg">
            <span class="text-2xl">ğŸ“¡</span>
          </div>
          <div class="ml-4">
            <p class="text-sm font-medium text-gray-600">æ€»RSSæº</p>
            <p class="text-2xl font-semibold text-gray-900">{totalSources}</p>
          </div>
        </div>
      </div>
      
      <div class="bg-white rounded-lg shadow p-6">
        <div class="flex items-center">
          <div class="p-2 bg-green-100 rounded-lg">
            <span class="text-2xl">âœ…</span>
          </div>
          <div class="ml-4">
            <p class="text-sm font-medium text-gray-600">æ¿€æ´»æº</p>
            <p class="text-2xl font-semibold text-gray-900">{activeSources}</p>
          </div>
        </div>
      </div>
      
      <div class="bg-white rounded-lg shadow p-6">
        <div class="flex items-center">
          <div class="p-2 bg-yellow-100 rounded-lg">
            <span class="text-2xl">ğŸ”</span>
          </div>
          <div class="ml-4">
            <p class="text-sm font-medium text-gray-600">ç­›é€‰ç»“æœ</p>
            <p class="text-2xl font-semibold text-gray-900">{filteredCount}</p>
          </div>
        </div>
      </div>
      
      <div class="bg-white rounded-lg shadow p-6">
        <div class="flex items-center">
          <div class="p-2 bg-purple-100 rounded-lg">
            <span class="text-2xl">ğŸ“Š</span>
          </div>
          <div class="ml-4">
            <p class="text-sm font-medium text-gray-600">å¥åº·åº¦</p>
            <p class="text-2xl font-semibold text-gray-900">
              {totalSources > 0 ? Math.round((activeSources / totalSources) * 100) : 0}%
            </p>
          </div>
        </div>
      </div>
    </div>

    <!-- ç­›é€‰é¢æ¿ -->
    <div class="bg-white shadow rounded-lg mb-6 p-6">
      <div class="grid grid-cols-1 md:grid-cols-5 gap-4">
        
        <!-- åˆ†ç±»ç­›é€‰ -->
        <div>
          <label class="block text-sm font-medium text-gray-700 mb-2">åˆ†ç±»</label>
          <select id="category-filter" class="w-full px-3 py-2 border border-gray-300 rounded-md text-sm">
            <option value="all">å…¨éƒ¨åˆ†ç±»</option>
            {categories.map(category => (
              <option value={category} selected={categoryFilter === category}>
                {category}
              </option>
            ))}
          </select>
        </div>

        <!-- çŠ¶æ€ç­›é€‰ -->
        <div>
          <label class="block text-sm font-medium text-gray-700 mb-2">çŠ¶æ€</label>
          <select id="status-filter" class="w-full px-3 py-2 border border-gray-300 rounded-md text-sm">
            <option value="all">å…¨éƒ¨çŠ¶æ€</option>
            <option value="active" selected={statusFilter === 'active'}>æ¿€æ´»</option>
            <option value="inactive" selected={statusFilter === 'inactive'}>æœªæ¿€æ´»</option>
          </select>
        </div>

        <!-- åœ°åŒºç­›é€‰ -->
        <div>
          <label class="block text-sm font-medium text-gray-700 mb-2">åœ°åŒº</label>
          <select id="region-filter" class="w-full px-3 py-2 border border-gray-300 rounded-md text-sm">
            <option value="all">å…¨éƒ¨åœ°åŒº</option>
            {regions.map(region => (
              <option value={region} selected={regionFilter === region}>
                {region}
              </option>
            ))}
          </select>
        </div>

        <!-- æŠ“å–ç­–ç•¥ç­›é€‰ -->
        <div>
          <label class="block text-sm font-medium text-gray-700 mb-2">æŠ“å–ç­–ç•¥</label>
          <select id="strategy-filter" class="w-full px-3 py-2 border border-gray-300 rounded-md text-sm">
            <option value="all">å…¨éƒ¨ç­–ç•¥</option>
            {strategies.map(strategy => (
              <option value={strategy} selected={strategyFilter === strategy}>
                {strategy}
              </option>
            ))}
          </select>
        </div>

        <!-- æ“ä½œæŒ‰é’® -->
        <div class="flex items-end">
          <button id="apply-filters" class="w-full px-4 py-2 bg-blue-500 text-white rounded-md hover:bg-blue-600">
            åº”ç”¨ç­›é€‰
          </button>
        </div>
      </div>
      
      <!-- æ“ä½œæŒ‰é’®è¡Œ -->
      <div class="flex space-x-4 mt-4 pt-4 border-t border-gray-200">
        <button id="test-all-sources" class="px-4 py-2 bg-green-500 text-white rounded-lg hover:bg-green-600">
          æµ‹è¯•æ‰€æœ‰æº
        </button>
        <button id="health-check" class="px-4 py-2 bg-yellow-500 text-white rounded-lg hover:bg-yellow-600">
          å¥åº·æ£€æŸ¥
        </button>
        <button id="refresh-data" class="px-4 py-2 bg-purple-500 text-white rounded-lg hover:bg-purple-600">
          åˆ·æ–°æ•°æ®
        </button>
        <button id="add-source" class="px-4 py-2 bg-indigo-500 text-white rounded-lg hover:bg-indigo-600">
          æ·»åŠ æº
        </button>
      </div>
    </div>

    <!-- RSSæºåˆ—è¡¨ -->
    <div class="bg-white shadow rounded-lg overflow-hidden">
      <div class="px-6 py-4 border-b border-gray-200">
        <h3 class="text-lg font-medium text-gray-900">
          RSSæºåˆ—è¡¨ ({filteredCount} æ¡è®°å½•)
        </h3>
      </div>
      
      <div class="overflow-x-auto">
        <table class="min-w-full divide-y divide-gray-200">
          <thead class="bg-gray-50">
            <tr>
              <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                æºä¿¡æ¯
              </th>
              <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                åˆ†ç±»
              </th>
              <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                åœ°åŒº
              </th>
              <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                æŠ“å–ç­–ç•¥
              </th>
              <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                çŠ¶æ€
              </th>
              <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                æˆåŠŸç‡
              </th>
              <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                æ“ä½œ
              </th>
            </tr>
          </thead>
          <tbody class="bg-white divide-y divide-gray-200">
            {filteredResources.map(source => (
              <tr class="hover:bg-gray-50">
                <td class="px-6 py-4 whitespace-nowrap">
                  <div class="flex items-center">
                    <div class="flex-shrink-0">
                      <span class="inline-flex items-center justify-center h-8 w-8 rounded-full bg-gray-500">
                        <span class="text-sm font-medium leading-none text-white">
                          {source.name?.charAt(0) || 'R'}
                        </span>
                      </span>
                    </div>
                    <div class="ml-4 min-w-0">
                      <div class="text-sm font-medium text-gray-900 truncate max-w-xs">
                        {source.name}
                      </div>
                      <div class="text-sm text-gray-500 truncate max-w-xs">
                        {source.url}
                      </div>
                      {source.description && (
                        <div class="text-xs text-gray-400 mt-1 max-w-xs truncate">
                          {source.description}
                        </div>
                      )}
                    </div>
                  </div>
                </td>
                <td class="px-6 py-4 whitespace-nowrap">
                  <span class={`inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium ${
                    source.category === 'Technology' ? 'bg-blue-100 text-blue-800' :
                    source.category === 'Business' ? 'bg-green-100 text-green-800' :
                    source.category === 'Policy' ? 'bg-purple-100 text-purple-800' :
                    'bg-gray-100 text-gray-800'
                  }`}>
                    {source.category}
                  </span>
                </td>
                <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">
                  {source.region}
                </td>
                <td class="px-6 py-4 whitespace-nowrap">
                  <span class={`inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium ${
                    source.crawl_strategy === 'google_news' ? 'bg-yellow-100 text-yellow-800' :
                    source.crawl_strategy === 'anti_scraping' ? 'bg-red-100 text-red-800' :
                    source.crawl_strategy === 'javascript_heavy' ? 'bg-orange-100 text-orange-800' :
                    'bg-gray-100 text-gray-800'
                  }`}>
                    {source.crawl_strategy}
                  </span>
                </td>
                <td class="px-6 py-4 whitespace-nowrap">
                  <span class={`inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium ${
                    source.is_active ? 'bg-green-100 text-green-800' : 'bg-red-100 text-red-800'
                  }`}>
                    <span class={`w-1.5 h-1.5 rounded-full mr-1 ${
                      source.is_active ? 'bg-green-400' : 'bg-red-400'
                    }`}></span>
                    {source.is_active ? 'æ¿€æ´»' : 'æœªæ¿€æ´»'}
                  </span>
                  <div class="text-xs text-gray-500 mt-1">
                    {source.last_fetch ? `æœ€åæŠ“å–: ${new Date(source.last_fetch).toLocaleDateString('zh-CN')}` : 'æœªæŠ“å–'}
                  </div>
                </td>
                <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">
                  {source.success_rate ? (
                    <div class="flex items-center">
                      <div class="flex-1">
                        <div class="flex items-center justify-between text-xs mb-1">
                          <span>{source.success_rate}%</span>
                        </div>
                        <div class="w-full bg-gray-200 rounded-full h-1.5">
                          <div 
                            class={`h-1.5 rounded-full ${
                              source.success_rate >= 80 ? 'bg-green-400' :
                              source.success_rate >= 60 ? 'bg-yellow-400' :
                              'bg-red-400'
                            }`}
                            style={`width: ${source.success_rate}%`}
                          ></div>
                        </div>
                      </div>
                    </div>
                  ) : (
                    <span class="text-gray-500">-</span>
                  )}
                </td>
                <td class="px-6 py-4 whitespace-nowrap text-right text-sm font-medium">
                  <div class="flex space-x-2">
                    <button 
                      onclick={`testSource('${source.id}')`}
                      class="text-blue-600 hover:text-blue-900 text-xs bg-blue-50 hover:bg-blue-100 px-2 py-1 rounded"
                    >
                      æµ‹è¯•
                    </button>
                    <button 
                      onclick={`toggleSource('${source.id}', ${!source.is_active})`}
                      class={`text-xs px-2 py-1 rounded ${
                        source.is_active 
                          ? 'text-red-600 hover:text-red-900 bg-red-50 hover:bg-red-100' 
                          : 'text-green-600 hover:text-green-900 bg-green-50 hover:bg-green-100'
                      }`}
                    >
                      {source.is_active ? 'åœç”¨' : 'å¯ç”¨'}
                    </button>
                    <button 
                      onclick={`editSource('${source.id}')`}
                      class="text-gray-600 hover:text-gray-900 text-xs bg-gray-50 hover:bg-gray-100 px-2 py-1 rounded"
                    >
                      ç¼–è¾‘
                    </button>
                  </div>
                  <div class={`test-status-${source.id} text-xs mt-1`}></div>
                </td>
              </tr>
            ))}
          </tbody>
        </table>
      </div>
      
      {filteredResources.length === 0 && (
        <div class="text-center py-12">
          <span class="text-4xl mb-4 block">ğŸ“­</span>
          <p class="text-gray-500">æ²¡æœ‰æ‰¾åˆ°ç¬¦åˆæ¡ä»¶çš„RSSæº</p>
        </div>
      )}
    </div>

    <!-- æµ‹è¯•ç»“æœé¢æ¿ -->
    <div id="test-results" class="hidden mt-8 bg-white shadow rounded-lg">
      <div class="px-6 py-4 border-b border-gray-200">
        <h3 class="text-lg font-medium text-gray-900">æµ‹è¯•ç»“æœ</h3>
      </div>
      <div id="test-results-content" class="p-6 max-h-96 overflow-y-auto">
      </div>
    </div>

  </div>

  <script define:vars={{ rssResourcesData: filteredResources }}>
    // ç­›é€‰åŠŸèƒ½
    document.getElementById('apply-filters').addEventListener('click', () => {
      const category = document.getElementById('category-filter').value
      const status = document.getElementById('status-filter').value
      const region = document.getElementById('region-filter').value
      const strategy = document.getElementById('strategy-filter').value
      
      const params = new URLSearchParams()
      if (category !== 'all') params.append('category', category)
      if (status !== 'all') params.append('status', status)
      if (region !== 'all') params.append('region', region)
      if (strategy !== 'all') params.append('strategy', strategy)
      
      window.location.href = `/test?${params.toString()}`
    })

    // æµ‹è¯•å•ä¸ªæº
    async function testSource(sourceId) {
      const statusElement = document.querySelector(`.test-status-${sourceId}`)
      statusElement.textContent = 'æµ‹è¯•ä¸­...'
      statusElement.className = 'test-status-' + sourceId + ' text-xs mt-1 text-yellow-600'
      
      try {
        const response = await fetch('/api/test-crawl', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ sourceId })
        })
        
        const result = await response.json()
        
        if (result.success) {
          statusElement.textContent = 'âœ… æˆåŠŸ'
          statusElement.className = 'test-status-' + sourceId + ' text-xs mt-1 text-green-600'
        } else {
          statusElement.textContent = 'âŒ å¤±è´¥'
          statusElement.className = 'test-status-' + sourceId + ' text-xs mt-1 text-red-600'
        }
        
        showTestResult(sourceId, result)
        
      } catch (error) {
        statusElement.textContent = 'âŒ é”™è¯¯'
        statusElement.className = 'test-status-' + sourceId + ' text-xs mt-1 text-red-600'
        console.error('æµ‹è¯•å¤±è´¥:', error)
      }
    }

    // åˆ‡æ¢æºçŠ¶æ€
    async function toggleSource(sourceId, newStatus) {
      try {
        const response = await fetch('/api/rss-sources/toggle', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ sourceId, isActive: newStatus })
        })
        
        if (response.ok) {
          location.reload()
        } else {
          alert('æ“ä½œå¤±è´¥')
        }
      } catch (error) {
        console.error('åˆ‡æ¢çŠ¶æ€å¤±è´¥:', error)
        alert('æ“ä½œå¤±è´¥')
      }
    }

    // ç¼–è¾‘æº
    function editSource(sourceId) {
      // TODO: å®ç°ç¼–è¾‘åŠŸèƒ½
      alert(`ç¼–è¾‘æº: ${sourceId}`)
    }

    // æµ‹è¯•æ‰€æœ‰æº
    document.getElementById('test-all-sources').addEventListener('click', async () => {
      const activeSourceIds = rssResourcesData.filter(s => s.is_active).map(s => s.id)
      
      for (const sourceId of activeSourceIds) {
        await testSource(sourceId)
        await new Promise(resolve => setTimeout(resolve, 1000)) // é¿å…è¿‡äºé¢‘ç¹çš„è¯·æ±‚
      }
    })
    
    // å¥åº·æ£€æŸ¥
    document.getElementById('health-check').addEventListener('click', async () => {
      try {
        const response = await fetch('/api/test-crawl?action=health')
        const result = await response.json()
        showTestResult('health-check', result)
      } catch (error) {
        console.error('å¥åº·æ£€æŸ¥å¤±è´¥:', error)
      }
    })

    // åˆ·æ–°æ•°æ®
    document.getElementById('refresh-data').addEventListener('click', () => {
      location.reload()
    })

    // æ·»åŠ æº
    document.getElementById('add-source').addEventListener('click', () => {
      // TODO: å®ç°æ·»åŠ æºåŠŸèƒ½
      alert('æ·»åŠ æ–°RSSæºåŠŸèƒ½å¼€å‘ä¸­...')
    })
    
    // æ˜¾ç¤ºæµ‹è¯•ç»“æœ
    function showTestResult(sourceId, result) {
      const resultsPanel = document.getElementById('test-results')
      const resultsContent = document.getElementById('test-results-content')
      
      resultsPanel.classList.remove('hidden')
      
      const resultDiv = document.createElement('div')
      resultDiv.className = 'mb-4 p-4 border rounded-lg ' + (result.success ? 'border-green-200 bg-green-50' : 'border-red-200 bg-red-50')
      resultDiv.innerHTML = `
        <h4 class="font-medium ${result.success ? 'text-green-800' : 'text-red-800'}">${sourceId}</h4>
        <pre class="text-sm mt-2 whitespace-pre-wrap max-h-40 overflow-y-auto">${JSON.stringify(result, null, 2)}</pre>
      `
      
      resultsContent.appendChild(resultDiv)
      resultsContent.scrollTop = resultsContent.scrollHeight
    }
    
    // ç»‘å®šåˆ°windowä»¥ä¾›onclickä½¿ç”¨
    window.testSource = testSource
    window.toggleSource = toggleSource
    window.editSource = editSource
  </script>
</Layout>